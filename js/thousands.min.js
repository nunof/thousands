var images_path="images/";var sndsa_path="soundsa/";var sndsb_path="soundsb/";var texts_file="config/text.txt";var images_list_file="config/imgs_index.txt";var sndsa_list_file="config/sndsa_index.txt";var sndsb_list_file="config/sndsb_index.txt";var layer1,layer2,layer3;var text1,text2,text3;var word1,word2,word3,word4;var fog_canvas,fog_ctx;var fScl=.0032;var P=Perlin;var fDeltaT=0;var fLastTime=0;var fBaseSpeed=2e-4;var fSpeed=fBaseSpeed;var fTime=0;var urls_ok=0;var stage,stage2;var hole_cur_x=0;var hole_cur_y=0;var hole_x_dir=1;var hole_y_dir=1;var hole_img;window.onload=function(){var count_move=0;var count_rotate=0;var initial_anim=true;var _row=30;var _col=300;stage=new Kinetic.Stage({container:"thousands",width:1e3,height:250});layer1=new Kinetic.Layer({opacity:1});text1=new Kinetic.Text({x:_col,y:_row,text:"Thou shalt not read or ear",fontSize:24,fontFamily:"Arial",fill:"black",draggable:false});text2=new Kinetic.Text({x:_col,y:_row+90,text:"Thou shalt not dread my dear",fontSize:24,fontFamily:"Arial",fill:"black",draggable:false});text3=new Kinetic.Text({x:_col,y:_row+20,text:"Thousand",fontSize:64,fontFamily:"Arial",fill:"black",draggable:false,visible:false});word1=new Kinetic.Text({x:_col+180,y:_row+75,text:"halt",fontSize:18,fontFamily:"Arial",fill:"blue",draggable:false,visible:false});word2=new Kinetic.Text({x:_col+255,y:_row+75,text:"ot",fontSize:18,fontFamily:"Arial",fill:"blue",draggable:false,visible:false});word3=new Kinetic.Text({x:_col+280,y:_row+28,text:"read",fontSize:18,fontFamily:"Arial",fill:"blue",draggable:false,visible:false});word4=new Kinetic.Text({x:_col+295,y:_row+75,text:"ear",fontSize:18,fontFamily:"Arial",fill:"blue",draggable:false,visible:false});layer1.add(text1);layer1.add(text2);layer1.add(text3);layer1.add(word1);layer1.add(word2);layer1.add(word3);layer1.add(word4);stage.add(layer1);var anim_id=setInterval(function(){if(initial_anim){if(count_move<90){text2.move(0,-10);count_move+=10}else{text3.setVisible(true);text1.setVisible(false);text2.setVisible(false);word1.setVisible(true);word2.setVisible(true);word3.setVisible(true);word4.setVisible(true);initial_anim=false}}else{if(count_rotate<90){word1.rotateDeg(10);word2.rotateDeg(10);word3.rotateDeg(-10);word4.rotateDeg(10);count_rotate+=10;if(count_rotate>=90){layer1.draw();clearInterval(anim_id);read_lists_and_go()}}}layer1.draw()},200)};function create_array_from_url_async(src_url){var txt_array=[];var txt_string="";var txt_url=new XMLHttpRequest;txt_url.open("GET",src_url,true);return txt_url.onreadystatechange=function(){if(txt_url.readyState==4){txt_string=txt_url.responseText;txt_array=txt_string.split(/\r\n|\n/);if(txt_array[txt_array.length-1]==""){txt_array.pop()}urls_ok++;return txt_array}};txt_url.send()}function create_array_from_url_sync(src_url){var txt_array=[];var txt_url=new XMLHttpRequest;txt_url.open("GET",src_url,false);txt_url.send();txt_string=txt_url.responseText;txt_array=txt_string.split(/\r\n|\n/);urls_ok++;if(txt_array[txt_array.length-1]==""){txt_array.pop()}return txt_array}function read_lists_and_go(){var sounds_a=[];var sounds_b=[];var images=[];var texts=[];images=create_array_from_url_sync(images_list_file);sounds_a=create_array_from_url_sync(sndsa_list_file);sounds_b=create_array_from_url_sync(sndsb_list_file);phrases=create_array_from_url_sync(texts_file);chk_files_arrival=setInterval(function(){if(urls_ok>=3){clearInterval(chk_files_arrival);main_scene(texts,images,sounds_a,sounds_b)}},250)}function main_scene(phrases,images,sounds_a,sounds_b){fog_canvas=document.getElementById("offscreen_canvas");fog_ctx=fog_canvas.getContext("2d");hole_img=new Image;hole_img.onload=function(){fog_ctx.drawImage(hole_img,hole_cur_x,hole_cur_y)};hole_img.src="alpha/hole1.png";stage2=new Kinetic.Stage({container:"container",width:1e3,height:400});var layer2=new Kinetic.Layer({opacity:1});var text_main=new Kinetic.Text({x:30,y:300,text:"",fontSize:18,fontFamily:"Arial",fill:"black",draggable:false,visible:true,opacity:.5});var image_obj=new Image;image_obj.onload=function(){var img_k=new Kinetic.Image({x:800,y:100,image:image_obj,width:image_obj.width,height:image_obj.height,opacity:.5});img_k.setImage(image_obj);layer2.removeChildren();text_main.setOpacity(Math.floor(Math.random()*11)/10);img_k.setOpacity(Math.floor(Math.random()*11)/10);text_main.setX(Math.floor(Math.random()*600));text_main.setY(Math.floor(Math.random()*200));img_k.setX(Math.floor(Math.random()*400));img_k.setY(Math.floor(Math.random()*100));layer2.add(text_main);layer2.add(img_k);stage2.add(layer2);layer3.moveToTop()};layer3=new Kinetic.Layer({opacity:1});stage2.add(layer3);var audio1=document.getElementById("stream1");var audio2=document.getElementById("stream2");audio1.loop=true;audio2.loop=true;audio1.volume=.5;audio2.volume=.5;Prng.seed=282;P.setRng(Prng);P.noiseDetail(3,.5);var mycanvas=layer3.getCanvas();var cwidth=mycanvas.width;var cheight=mycanvas.height;var ctx=mycanvas.getContext();var cdata=ctx.getImageData(0,0,cwidth,cheight);setInterval(function(){fDeltaT=millis()-fLastTime;fLastTime=millis()},1);anime_fog(ctx,cdata,cwidth,cheight);chg_txt_n_img(text_main,image_obj,images);go_audio(audio1,sounds_a,sndsa_path);go_audio(audio2,sounds_b,sndsb_path)}function anime_fog(ctx,cdata,cwidth,cheight){fTime+=fDeltaT*fSpeed;zz=fTime;t=millis();for(i=0;i<cdata.data.length;i+=4){ii=Math.floor(i/4);x=ii%cwidth;y=Math.floor(ii/cheight);fDff=1.5;xx=0+x*fScl*fDff;yy=0+y*fScl*fDff;fNoise=Math.floor(P.noise(xx,yy,zz)*256);cdata.data[i]=cdata.data[i+1]=cdata.data[i+2]=fNoise;cdata.data[i+3]=fog_level}if(hole_x_dir==1&&hole_cur_x+200<cwidth||hole_x_dir==-1&&hole_cur_x>0)hole_cur_x=hole_cur_x+10*hole_x_dir;else hole_x_dir*=-1;if(hole_y_dir==1&&hole_cur_y+200<cheight||hole_y_dir==-1&&hole_cur_y>0)hole_cur_y=hole_cur_y+10*hole_y_dir;else hole_y_dir*=-1;if(eye_mode==0)fog_ctx.clearRect(0,0,cwidth,cheight);fog_ctx.drawImage(hole_img,hole_cur_x,hole_cur_y);tmp=fog_ctx.getImageData(0,0,cwidth,cheight);ctx.putImageData(fog_hole(cdata,tmp,cwidth,cheight),0,0);setTimeout(function(){anime_fog(ctx,cdata,cwidth,cheight)},200)}function fog_hole(fog,hole,w,h){for(var i=3,len=fog.data.length;i<len;i+=4){if(fog.data[i]<hole.data[i]){fog.data[i]=0}}return fog}function chg_txt_n_img(txt_obj,img_obj,img_list){phrase_idx=Math.floor(Math.random()*phrases.length);image_idx=Math.floor(Math.random()*img_list.length);txt_obj.setText(phrases[phrase_idx]);img_obj.src=images_path+img_list[image_idx];setTimeout(function(){chg_txt_n_img(txt_obj,img_obj,img_list)},def_txt_n_img_speed)}function go_audio(audio_obj,sounds_list,path){var duration=0;snds_idx=Math.floor(Math.random()*sounds_list.length);audio_obj.setAttribute("src",path+sounds_list[snds_idx]);audio_obj.load();audio_obj.addEventListener("loadedmetadata",function(){duration=audio_obj.duration});audio_obj.addEventListener("canplay",function(){audio_obj.play()},true);if(duration==0){duration=def_snd_speed}setTimeout(function(){go_audio(audio_obj,sounds_list,path)},duration)}function imagedata_from_img(img_url,width,height,callack){var tmpcanvas=document.getElementById("offscreen_canvas");tmpcanvas.width=width;tmpcanvas.height=height;var context=tmpcanvas.getContext("2d");var tmpimg=new Image;tmpimg.onload=function(){context.drawImage(tmpimg,0,0,width,height);img_data=context.getImageData(0,0,width,height);tmpcanvas.width=1;tmpcanvas.height=1;callack(img_data)};tmpimg.src=img_url}function image2canvas(image){var canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;canvas.getContext("2d").drawImage(image,0,0);return canvas}function canvas2image(canvas){var image=new Image;image.src=canvas.toDataURL("image/png");return image}